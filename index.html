<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Bubble Shooter Web3 PRO</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:url("background.png") no-repeat center center fixed;
  background-size:cover;
  color:#fff;
}

/* layout geral */
#layout{
  display:flex;
  width:100%;
  height:100vh;
  padding:20px;
  gap:15px;
}

/* painel lateral */
#panel{
  width:320px;
  background:rgba(0,0,0,0.85);
  border:1px solid rgba(0,255,170,0.5);
  border-radius:14px;
  padding:12px;
  font-size:13px;
  backdrop-filter:blur(6px);
}

h2{
  text-align:center;
  color:#00ffaa;
  margin:4px 0 10px;
}

.row{
  display:flex;
  justify-content:space-between;
  margin:3px 0;
}

/* bot√µes */
button{
  width:100%;
  margin:5px 0;
  padding:8px;
  border:none;
  border-radius:8px;
  background:linear-gradient(90deg,#00ffaa,#00aaff);
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
button:disabled{
  opacity:.4;
  cursor:not-allowed;
}

/* barra de for√ßa */
.bar{
  width:100%;
  height:10px;
  background:rgba(255,255,255,0.1);
  border-radius:6px;
  overflow:hidden;
}
#powerBar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#00ff88,#ffff00,#ff0000);
}

/* calculadora comum */
#calc{
  margin-top:8px;
  padding:8px;
  background:rgba(255,255,255,0.05);
  border-radius:10px;
}
#calc input{
  width:100%;
  margin:3px 0;
  padding:6px;
  border-radius:6px;
  border:none;
}
.calcBtns{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:4px;
}
.calcBtns button{
  padding:6px;
  font-size:14px;
}

/* container do jogo */
#gameContainer{
  flex:1;
  height:70vh;
  position:relative;
  border:1px solid rgba(0,255,170,0.5);
  border-radius:16px;
  overflow:hidden;
  background:rgba(0,0,0,0.1);
}

/* overlay bloqueio (90%) */
#overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.9);
  z-index:10;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:22px;
  font-weight:bold;
}

/* canvas */
canvas{
  width:100%;
  height:100%;
  display:block;
  background:transparent;
  z-index:1;
}

/* ticker cripto */
#ticker{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  background:black;
  border-top:2px solid #00ffaa;
  font-size:13px;
  font-weight:bold;
  color:#00ffaa;
  overflow:hidden;
  z-index:20;
}
#tickerTrack{
  display:inline-block;
  white-space:nowrap;
  padding-left:100%;
  animation:scroll 25s linear infinite;
}
@keyframes scroll{
  from{transform:translateX(0);}
  to{transform:translateX(-100%);}
}
</style>
</head>
<body>

<div id="layout">

  <!-- PAINEL -->
  <div id="panel">
    <h2>üéÆ Bubble Shooter Web3</h2>

    <div class="row">üëõ Wallet: <span id="wallet">---</span></div>
    <div class="row">üí∞ USDC: <span id="balance">0.000</span></div>
    <div class="row">‚≠ê Score: <span id="score">0</span></div>
    <div class="row">üî• Combo: <span id="combo">0</span></div>
    <div class="row">üéØ Level: <span id="level">1</span></div>

    <div>‚ö° For√ßa do tiro</div>
    <div class="bar"><div id="powerBar"></div></div>

    <button id="btnConnect">üîó Conectar Carteira</button>
    <button id="btnSign" disabled>‚úçÔ∏è Assinar</button>
    <button id="btnStart" disabled>‚ñ∂Ô∏è Iniciar Jogo</button>

    <button onclick="deposit()">Depositar (simulado)</button>
    <button onclick="withdraw()">Sacar (simulado)</button>

    <!-- CALCULADORA NORMAL -->
    <div id="calc">
      <b>üßÆ Calculadora</b>
      <input type="number" id="n1" placeholder="N√∫mero 1">
      <input type="number" id="n2" placeholder="N√∫mero 2">
      <div class="calcBtns">
        <button onclick="calcOp('+')">+</button>
        <button onclick="calcOp('-')">-</button>
        <button onclick="calcOp('*')">*</button>
        <button onclick="calcOp('/')">/</button>
      </div>
      <div id="calcResult">Resultado: -</div>
    </div>
  </div>

  <!-- JOGO -->
  <div id="gameContainer">
    <div id="overlay">üîí Conecte e assine a carteira para jogar</div>
    <canvas id="game"></canvas>
    <div id="ticker"><div id="tickerTrack">Carregando pre√ßos...</div></div>
  </div>

</div>

<audio id="explosionSound" src="explosion.mp3"></audio>

<script>
/* ================= CONFIG ARC TESTNET ================= */
const ARC_CHAIN = {
  chainId: "0x4CF7D2",
  chainName: "ARC Testnet",
  rpcUrls: ["https://rpc.testnet.arc.network"],
  nativeCurrency: { name:"ARC", symbol:"ARC", decimals:18 },
  blockExplorerUrls: []
};

let provider, signer, account;
let signed=false;

/* ================= UI ================= */
const walletEl=wallet;
const balanceEl=balance;
const scoreEl=score;
const comboEl=combo;
const levelEl=level;
const btnConnect=document.getElementById("btnConnect");
const btnSign=document.getElementById("btnSign");
const btnStart=document.getElementById("btnStart");

const State={score:0,combo:0,level:1,balance:0};

function updateUI(){
  walletEl.textContent = account ? account.slice(0,6)+"..."+account.slice(-4) : "---";
  balanceEl.textContent = State.balance.toFixed(3);
  scoreEl.textContent = State.score;
  comboEl.textContent = State.combo;
  levelEl.textContent = State.level;
}

/* ================= METAMASK EST√ÅVEL ================= */
btnConnect.onclick = async ()=>{
  if(!window.ethereum){
    alert("MetaMask n√£o encontrada!");
    return;
  }

  try{
    const accounts = await ethereum.request({method:"eth_requestAccounts"});

    try{
      await ethereum.request({
        method:"wallet_switchEthereumChain",
        params:[{chainId: ARC_CHAIN.chainId}]
      });
    }catch(e){
      await ethereum.request({
        method:"wallet_addEthereumChain",
        params:[ARC_CHAIN]
      });
    }

    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    account = accounts[0];

    updateUI();
    btnSign.disabled=false;

  }catch(e){
    alert("Erro ao conectar carteira!");
  }
};

btnSign.onclick = async ()=>{
  try{
    await signer.signMessage("Autorizo jogar Bubble Shooter Web3");
    signed=true;
    btnStart.disabled=false;
    alert("Assinatura OK ‚úÖ");
  }catch(e){
    alert("Assinatura cancelada!");
  }
};

btnStart.onclick = ()=>{
  if(!signed)return;
  overlay.style.display="none";
  Game.start();
};

/* ================= SOM ================= */
const explosionSound=document.getElementById("explosionSound");
function playExplosion(){
  explosionSound.currentTime=0;
  explosionSound.play().catch(()=>{});
}

/* ================= CANVAS ================= */
const container=document.getElementById("gameContainer");
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=container.clientWidth;
  canvas.height=container.clientHeight;
}
window.addEventListener("resize",resize);
resize();

/* ================= GAME ENGINE ================= */
const Game={
  bubbles:[],
  bullet:{x:0,y:0,r:20,dx:0,dy:0,active:false},
  charging:false,
  power:0,
  maxPower:20,
  mouse:{x:0,y:0},
  running:false,

  start(){
    this.running=true;
    this.init();
    loop();
  },

  init(){
    this.bubbles=[];
    const colors=["#00ff88","#00aaff","#ffaa00","#ff4444","#aa00ff"];
    const gapX=44;
    const gapY=42;
    const cols=Math.floor(canvas.width/gapX);
    const rows=Math.floor(canvas.height*0.65/gapY);

    for(let i=0;i<rows;i++){
      for(let j=0;j<cols;j++){
        this.bubbles.push({
          x:gapX/2+j*gapX,
          y:gapY/2+i*gapY,
          r:16,
          color:colors[Math.floor(Math.random()*colors.length)],
          active:true
        });
      }
    }
    this.resetBullet();
  },

  resetBullet(){
    this.bullet.x=canvas.width/2;
    this.bullet.y=canvas.height-40;
    this.bullet.active=false;
  },

  shoot(angle){
    if(this.bullet.active)return;
    const speed=4+this.power;
    this.bullet.dx=Math.cos(angle)*speed;
    this.bullet.dy=Math.sin(angle)*speed;
    this.bullet.active=true;
    this.power=0;
    powerBar.style.width="0%";
  },

  update(){
    if(!this.running)return;

    if(this.charging){
      this.power=Math.min(this.maxPower,this.power+0.25);
      powerBar.style.width=(this.power/this.maxPower*100)+"%";
    }

    if(this.bullet.active){
      this.bullet.x+=this.bullet.dx;
      this.bullet.y+=this.bullet.dy;

      if(this.bullet.x<0||this.bullet.x>canvas.width) this.bullet.dx*=-1;
      if(this.bullet.y<0){
        this.resetBullet();
        State.combo=0;
      }

      for(const b of this.bubbles){
        if(!b.active)continue;
        const d=Math.hypot(this.bullet.x-b.x,this.bullet.y-b.y);
        if(d<this.bullet.r+b.r){
          b.active=false;
          playExplosion();
          State.combo++;
          State.score+=10*State.combo;
          State.balance+=0.001;
          this.resetBullet();
        }
      }
    }

    if(this.bubbles.filter(b=>b.active).length<5){
      State.level++;
      this.init();
    }
  },

  draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    for(const b of this.bubbles){
      if(!b.active)continue;
      ctx.beginPath();
      ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
      ctx.fillStyle=b.color;
      ctx.shadowBlur=12;
      ctx.shadowColor=b.color;
      ctx.fill();
      ctx.shadowBlur=0;
    }

    ctx.beginPath();
    ctx.arc(this.bullet.x,this.bullet.y,this.bullet.r,0,Math.PI*2);
    ctx.fillStyle="#fff";
    ctx.fill();
  }
};

canvas.addEventListener("mousemove",e=>{
  const r=canvas.getBoundingClientRect();
  Game.mouse.x=e.clientX-r.left;
  Game.mouse.y=e.clientY-r.top;
});
canvas.addEventListener("mousedown",()=>Game.charging=true);
canvas.addEventListener("mouseup",()=>{
  Game.charging=false;
  const angle=Math.atan2(Game.mouse.y-Game.bullet.y,Game.mouse.x-Game.bullet.x);
  Game.shoot(angle);
});

function loop(){
  Game.update();
  Game.draw();
  updateUI();
  requestAnimationFrame(loop);
}

/* ================= DEP√ìSITO SIMULADO ================= */
function deposit(){State.balance+=0.01;}
function withdraw(){
  if(State.balance<0.01)return alert("Saldo insuficiente");
  State.balance-=0.01;
}

/* ================= CALCULADORA ================= */
function calcOp(op){
  const a=parseFloat(n1.value||0);
  const b=parseFloat(n2.value||0);
  let r=0;
  switch(op){
    case "+": r=a+b; break;
    case "-": r=a-b; break;
    case "*": r=a*b; break;
    case "/": r=b===0?"‚àû":a/b; break;
  }
  calcResult.textContent="Resultado: "+r;
}

/* ================= TICKER CRIPTO ================= */
async function loadPrices(){
  try{
    const ids="bitcoin,ethereum,solana,xrp,bnb,dogecoin";
    const res=await fetch(
      "https://api.coingecko.com/api/v3/simple/price?ids="+ids+"&vs_currencies=usd"
    );
    const data=await res.json();
    let text="";
    for(const k in data){
      text += `üöÄ ${k.toUpperCase()}: $${data[k].usd} &nbsp;&nbsp;`;
    }
    tickerTrack.innerHTML=text;
  }catch(e){
    tickerTrack.innerHTML="Erro ao carregar pre√ßos...";
  }
}
loadPrices();
setInterval(loadPrices,5000);
</script>
</body>
</html>
