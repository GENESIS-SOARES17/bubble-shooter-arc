<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ARC Bubble Shooter Web3</title>
<style>
body{
  margin:0;
  background:#050b14;
  color:#fff;
  font-family:Arial;
  overflow:hidden;
}
#ui{
  position:fixed;
  top:10px;
  left:10px;
  z-index:10;
  background:rgba(0,0,0,.6);
  padding:10px;
  border-radius:10px;
  font-size:14px;
}
button{
  background:#00ffaa;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
  margin:2px;
}
#menu{
  position:fixed;
  right:10px;
  top:10px;
  background:rgba(0,0,0,.6);
  padding:10px;
  border-radius:10px;
}
#calc{
  position:fixed;
  bottom:10px;
  left:10px;
  background:rgba(0,0,0,.6);
  padding:10px;
  border-radius:10px;
}
canvas{display:block;}
.bar{
  width:200px;
  height:10px;
  background:#222;
  border-radius:6px;
  overflow:hidden;
}
.bar div{
  height:100%;
  background:#00ffaa;
  width:0%;
}
</style>
</head>
<body>

<div id="ui">
  <div>Wallet: <span id="wallet">desconectada</span></div>
  <div>Rede: <span id="network">---</span></div>
  <div>Saldo: <span id="balance">0</span> USDC</div>
  <div>Score: <span id="score">0</span></div>
  <div>Combo: <span id="combo">x1</span></div>
  <div class="bar"><div id="powerBar"></div></div>
  <button onclick="connectWallet()">Conectar MetaMask</button>
  <button onclick="deposit()">Depositar 0.01 USDC</button>
  <button onclick="withdraw()">Sacar</button>
</div>

<div id="menu">
  <h4>üèÜ Ranking</h4>
  <div id="rank"></div>
</div>

<div id="calc">
  <h4>üí± Calculadora Crypto</h4>
  <input id="calcValue" placeholder="Valor" size="8">
  <select id="calcFrom">
    <option>USDC</option>
    <option>ETH</option>
    <option>BTC</option>
  </select>
  ‚Üí
  <select id="calcTo">
    <option>BRL</option>
    <option>USD</option>
  </select>
  <button onclick="convert()">Converter</button>
  <div id="calcResult"></div>
</div>

<canvas id="game"></canvas>

<script>
/* ===========================
 CONFIG WEB3 ARC NETWORK
=========================== */
const ARC_CHAIN = {
  chainId:"0x4CEF52",
  chainName:"ARC Testnet",
  rpcUrls:["https://rpc.testnet.arc.network"],
  nativeCurrency:{name:"ARC",symbol:"ARC",decimals:18},
  blockExplorerUrls:["https://explorer.arc.network"]
};

const USDC_ADDRESS="0x3600000000000000000000000000000000000000";

/* ===========================
 GLOBAL STATE
=========================== */
let provider=null;
let account=null;
let cooldowns={};

const State={
  balance:0,
  score:0,
  combo:1,
  level:1
};

/* ===========================
 META MASK CONNECTION FIXED ‚úÖ
=========================== */
async function connectWallet(){
  if(!window.ethereum){
    alert("MetaMask n√£o encontrada");
    return;
  }

  provider=window.ethereum;

  try{
    // request accounts
    const accounts=await provider.request({method:"eth_requestAccounts"});
    account=accounts[0];
    document.getElementById("wallet").innerText=account.slice(0,6)+"..."+account.slice(-4);

    // switch or add chain
    try{
      await provider.request({
        method:"wallet_switchEthereumChain",
        params:[{chainId:ARC_CHAIN.chainId}]
      });
    }catch(e){
      await provider.request({
        method:"wallet_addEthereumChain",
        params:[ARC_CHAIN]
      });
    }

    document.getElementById("network").innerText="ARC Testnet";

    provider.on("accountsChanged",(acc)=>{
      if(acc.length===0){
        account=null;
        document.getElementById("wallet").innerText="desconectada";
      }else{
        account=acc[0];
        document.getElementById("wallet").innerText=account.slice(0,6)+"..."+account.slice(-4);
      }
    });

    provider.on("chainChanged",()=>location.reload());

  }catch(err){
    console.error(err);
  }
}

/* ===========================
 COOLDOWN 3H
=========================== */
function canPlay(){
  if(!account) return false;
  const now=Date.now();
  if(!cooldowns[account] || now-cooldowns[account]>3*60*60*1000){
    cooldowns[account]=now;
    return true;
  }
  return false;
}

/* ===========================
 FAKE USDC ECONOMY (SIMULADA)
=========================== */
function deposit(){
  if(!account) return alert("Conecte a carteira");
  State.balance+=0.01;
  updateUI();
}
function withdraw(){
  if(State.balance<0.10) return alert("Saldo m√≠nimo 0.10");
  State.balance-=0.10;
  updateUI();
}

/* ===========================
 CRYPTO CONVERTER API
=========================== */
async function convert(){
  const val=parseFloat(document.getElementById("calcValue").value);
  const from=document.getElementById("calcFrom").value;
  const to=document.getElementById("calcTo").value;

  const url=`https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,usd-coin&vs_currencies=${to.toLowerCase()}`;
  const data=await fetch(url).then(r=>r.json());

  let price=1;
  if(from==="BTC") price=data.bitcoin[to.toLowerCase()];
  if(from==="ETH") price=data.ethereum[to.toLowerCase()];
  if(from==="USDC") price=data["usd-coin"][to.toLowerCase()];

  document.getElementById("calcResult").innerText=(val*price).toFixed(2)+" "+to;
}

/* ===========================
 GAME ENGINE
=========================== */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
}
resize();
window.addEventListener("resize",resize);

const Game={
  bubbles:[],
  particles:[],
  bullet:{x:0,y:0,r:15,dx:0,dy:0,active:false},
  charging:false,
  power:0,

  init(){
    this.bubbles=[];
    const colors=["#00ffaa","#ffaa00","#ff4444","#44aaff"];
    const gapX=50, gapY=45;
    const cols=Math.floor(canvas.width/gapX);
    const rows=Math.floor(canvas.height*0.7/gapY);

    for(let i=0;i<rows;i++){
      for(let j=0;j<cols;j++){
        let type="normal";
        if(Math.random()<0.05) type="bomb";
        if(Math.random()<0.05) type="gold";
        if(Math.random()<0.05) type="multi";

        this.bubbles.push({
          x:gapX/2+j*gapX,
          y:gapY/2+i*gapY,
          r:18,
          color:colors[(i+j)%4],
          active:true,
          type
        });
      }
    }
    this.resetBullet();
  },

  resetBullet(){
    this.bullet.x=canvas.width/2;
    this.bullet.y=canvas.height-50;
    this.bullet.dx=0;
    this.bullet.dy=0;
    this.bullet.active=false;
  },

  shoot(angle){
    if(this.bullet.active) return;
    this.bullet.active=true;
    this.bullet.dx=Math.cos(angle)*this.power*10;
    this.bullet.dy=Math.sin(angle)*this.power*10;
    this.power=0;
  },

  explode(x,y,color){
    for(let i=0;i<20;i++){
      this.particles.push({
        x,y,
        dx:(Math.random()-0.5)*6,
        dy:(Math.random()-0.5)*6,
        life:30,
        color
      });
    }
  },

  update(){
    if(this.charging){
      this.power=Math.min(1,this.power+0.02);
      document.getElementById("powerBar").style.width=(this.power*100)+"%";
    }

    if(this.bullet.active){
      this.bullet.x+=this.bullet.dx;
      this.bullet.y+=this.bullet.dy;

      for(const b of this.bubbles){
        if(!b.active) continue;
        const d=Math.hypot(this.bullet.x-b.x,this.bullet.y-b.y);
        if(d<b.r+this.bullet.r){
          b.active=false;
          this.explode(b.x,b.y,b.color);

          let points=10;
          if(b.type==="gold") points=50;
          if(b.type==="multi") State.combo++;
          if(b.type==="bomb"){
            this.bubbles.forEach(bb=>{
              if(Math.hypot(bb.x-b.x,bb.y-b.y)<100) bb.active=false;
            });
          }

          State.score+=points*State.combo;
          State.balance+=0.001;
          this.resetBullet();
        }
      }

      if(this.bullet.y<0) this.resetBullet();
    }

    this.particles.forEach(p=>{
      p.x+=p.dx;
      p.y+=p.dy;
      p.life--;
    });
    this.particles=this.particles.filter(p=>p.life>0);
  },

  draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    this.bubbles.forEach(b=>{
      if(!b.active) return;
      ctx.beginPath();
      ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
      ctx.fillStyle=b.color;
      ctx.fill();
      if(b.type!=="normal"){
        ctx.fillStyle="#fff";
        ctx.fillText(b.type[0].toUpperCase(),b.x-4,b.y+4);
      }
    });

    this.particles.forEach(p=>{
      ctx.fillStyle=p.color;
      ctx.fillRect(p.x,p.y,3,3);
    });

    ctx.beginPath();
    ctx.arc(this.bullet.x,this.bullet.y,this.bullet.r,0,Math.PI*2);
    ctx.fillStyle="#fff";
    ctx.fill();
  }
};

canvas.addEventListener("mousedown",(e)=>{
  Game.charging=true;
});
canvas.addEventListener("mouseup",(e)=>{
  Game.charging=false;
  const angle=-Math.PI/2;
  Game.shoot(angle);
});

function loop(){
  Game.update();
  Game.draw();
  updateUI();
  requestAnimationFrame(loop);
}

function updateUI(){
  document.getElementById("balance").innerText=State.balance.toFixed(3);
  document.getElementById("score").innerText=State.score;
  document.getElementById("combo").innerText="x"+State.combo;
}

Game.init();
loop();
</script>
</body>
</html>