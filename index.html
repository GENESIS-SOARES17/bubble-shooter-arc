<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Shooter Web3 PRO - Refatorado</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #00ffaa; --secondary: #00aaff; --bg: #0a0a0a; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); color: #fff; overflow: hidden; }
       
        #layout { display: flex; width: 100vw; height: 100vh; padding: 15px; gap: 15px; }
       
        /* Painel Lateral */
        #panel {
            width: 320px; background: rgba(0,0,0,0.9); border: 1px solid rgba(0,255,170,0.3);
            border-radius: 16px; padding: 20px; display: flex; flex-direction: column; gap: 10px;
            backdrop-filter: blur(10px); box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        h2 { text-align: center; color: var(--primary); margin: 0 0 10px; font-size: 22px; }
        .stats { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; }
        .row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 14px; }
        .val { font-weight: bold; color: var(--secondary); }
        button {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        /* Jogo */
        #gameContainer {
            flex: 1; position: relative; border: 1px solid rgba(0,255,170,0.3);
            border-radius: 16px; background: #000; overflow: hidden;
        }
        canvas { width: 100%; height: 100%; display: block; }
        #overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 10; display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-align: center; padding: 20px;
        }
        /* Barra de ForÃ§a */
        .bar-wrap { margin-top: 10px; font-size: 12px; color: #aaa; }
        .bar { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        #powerBar { height: 100%; width: 0%; background: linear-gradient(90deg, #00ff88, #ff0000); transition: width 0.1s; }
        /* Ticker */
        #ticker {
            position: absolute; bottom: 0; width: 100%; background: #000;
            border-top: 1px solid var(--primary); padding: 5px 0; font-size: 12px;
        }
        #tickerTrack { display: inline-block; white-space: nowrap; animation: scroll 30s linear infinite; }
        @keyframes scroll { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
    </style>
</head>
<body>
<div id="layout">
    <div id="panel">
        <h2>Bubble Shooter</h2>
       
        <div class="stats">
            <div class="row"><span>Wallet:</span> <span id="wallet" class="val">---</span></div>
            <div class="row"><span>Saldo ARC:</span> <span id="balance" class="val">0.000</span></div>
            <div class="row"><span>Score:</span> <span id="score" class="val">0</span></div>
            <div class="row"><span>Level:</span> <span id="level" class="val">1</span></div>
        </div>
        <div class="bar-wrap">
            âš¡ PotÃªncia do Disparo
            <div class="bar"><div id="powerBar"></div></div>
        </div>
        <button id="btnConnect">1. Conectar MetaMask</button>
        <button id="btnSign" disabled>2. Assinar Termos</button>
        <button id="btnStart" disabled>3. Iniciar Partida</button>
        <div style="margin-top:auto; font-size: 10px; color: #666; text-align: center;">
            ARC Testnet v1.0 - Modo SimulaÃ§Ã£o Protegido
        </div>
    </div>
    <div id="gameContainer">
        <div id="overlay">
            <h1 id="statusMsg">ðŸ”’ Bloqueado</h1>
            <p>Conecte sua carteira para liberar o acesso ao jogo.</p>
        </div>
        <canvas id="game"></canvas>
        <div id="ticker"><div id="tickerTrack">Carregando mercado...</div></div>
    </div>
</div>
<script>
/* --- CONFIGURAÃ‡Ã•ES --- */
const ARC_CHAIN = {
    chainId: "0x4cef52",
    chainName: "ARC Testnet",
    rpcUrls: ["https://rpc.testnet.arc.network"],
    nativeCurrency: { name: "USDC", symbol: "USDC", decimals: 6 }
};
let provider, signer, account;
let signed = false;
const state = { score: 0, balance: 0, level: 1, combo: 0 };
/* --- ELEMENTOS UI --- */
const ui = {
    wallet: document.getElementById("wallet"),
    balance: document.getElementById("balance"),
    score: document.getElementById("score"),
    level: document.getElementById("level"),
    power: document.getElementById("powerBar"),
    overlay: document.getElementById("overlay"),
    btnConnect: document.getElementById("btnConnect"),
    btnSign: document.getElementById("btnSign"),
    btnStart: document.getElementById("btnStart")
};
function updateUI() {
    ui.wallet.textContent = account ? `${account.slice(0,6)}...${account.slice(-4)}` : "---";
    ui.balance.textContent = state.balance.toFixed(4);
    ui.score.textContent = state.score;
    ui.level.textContent = state.level;
}
/* --- WEB3 LOGIC --- */
ui.btnConnect.onclick = async () => {
    if (!window.ethereum) {
        alert("MetaMask nÃ£o detectada! Instale ou ative a extensÃ£o.");
        return;
    }

    try {
        const accounts = await ethereum.request({ method: "eth_requestAccounts" });
        account = accounts[0];

        try {
            await ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: ARC_CHAIN.chainId }]
            });
        } catch (switchError) {
            if (switchError.code === 4902) {  // rede nÃ£o adicionada
                try {
                    await ethereum.request({
                        method: "wallet_addEthereumChain",
                        params: [ARC_CHAIN]
                    });
                    // ApÃ³s adicionar, tenta trocar novamente
                    await ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: ARC_CHAIN.chainId }]
                    });
                } catch (addError) {
                    console.error("Falha ao adicionar rede:", addError);
                    alert("NÃ£o foi possÃ­vel adicionar a ARC Testnet. Verifique manualmente no ChainList ou docs oficiais.");
                    return;
                }
            } else {
                console.error("Erro ao trocar rede:", switchError);
                alert("Falha ao trocar para ARC Testnet. Verifique se a rede estÃ¡ correta.");
                return;
            }
        }

        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        
        ui.btnSign.disabled = false;
        ui.btnConnect.textContent = "âœ… Conectado";
        ui.btnConnect.disabled = true;
        updateUI();
        alert("Carteira conectada! Agora assine os termos para jogar.");
    } catch (e) {
        console.error("Erro completo na conexÃ£o:", e);
        alert("Falha na conexÃ£o. Tente novamente ou verifique o console (F12).");
    }
};
ui.btnSign.onclick = async () => {
    if (!signer) return alert("Conecte a carteira primeiro.");
    
    try {
        ui.btnSign.textContent = "Assinando...";
        ui.btnSign.disabled = true;
        
        await signer.signMessage("AutenticaÃ§Ã£o Bubble Shooter Web3 - " + new Date().toISOString());
        signed = true;
        ui.btnSign.textContent = "âœ… Assinado";
        ui.btnStart.disabled = false;
        
        document.getElementById("statusMsg").textContent = "ðŸ”“ Pronto para jogar!";
        alert("Assinatura concluÃ­da! Clique em 'Iniciar Partida'.");
    } catch (e) {
        console.error("Erro na assinatura:", e);
        ui.btnSign.textContent = "2. Assinar Termos";
        ui.btnSign.disabled = false;
        if (e.code === 4001) {
            alert("Assinatura cancelada pelo usuÃ¡rio.");
        } else {
            alert("Falha na assinatura. Verifique se estÃ¡ na rede ARC Testnet.");
        }
    }
};
ui.btnStart.onclick = () => {
    ui.overlay.style.display = "none";
    initAudio(); // Inicializa Ã¡udio no clique do usuÃ¡rio
    Game.init();
};
/* --- AUDIO ENGINE (WEB AUDIO API) --- */
let audioCtx;
function initAudio() { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playPop() {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(400, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
}
/* --- GAME ENGINE --- */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const Game = {
    bubbles: [],
    bullet: { x: 0, y: 0, r: 12, dx: 0, dy: 0, active: false, color: '#fff' },
    isCharging: false,
    power: 0,
    maxPower: 15,
    init() {
        this.resize();
        window.onresize = () => this.resize();
        this.generateLevel();
        this.resetBullet();
        this.loop();
    },
    resize() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
    },
    generateLevel() {
        const colors = ["#00ffaa", "#00aaff", "#ffaa00", "#ff4444"];
        this.bubbles = [];
        const rows = 5 + state.level;
        const cols = Math.floor(canvas.width / 45);
        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                this.bubbles.push({
                    x: 30 + c * 40,
                    y: 40 + r * 35,
                    r: 15,
                    color: colors[Math.floor(Math.random()*colors.length)],
                    active: true
                });
            }
        }
    },
    resetBullet() {
        this.bullet.active = false;
        this.bullet.x = canvas.width / 2;
        this.bullet.y = canvas.height - 50;
    },
    update() {
        if (this.isCharging) {
            this.power = Math.min(this.maxPower, this.power + 0.2);
            ui.power.style.width = (this.power / this.maxPower * 100) + "%";
        }
        if (this.bullet.active) {
            this.bullet.x += this.bullet.dx;
            this.bullet.y += this.bullet.dy;
            // ColisÃ£o com Paredes (Refatorada para nÃ£o prender)
            if (this.bullet.x - this.bullet.r < 0) {
                this.bullet.x = this.bullet.r;
                this.bullet.dx *= -1;
            } else if (this.bullet.x + this.bullet.r > canvas.width) {
                this.bullet.x = canvas.width - this.bullet.r;
                this.bullet.dx *= -1;
            }
            if (this.bullet.y < 0) {
                this.resetBullet();
                state.combo = 0;
            }
            // ColisÃ£o com Bolhas
            for (let b of this.bubbles) {
                if (!b.active) continue;
                const dist = Math.hypot(this.bullet.x - b.x, this.bullet.y - b.y);
                if (dist < this.bullet.r + b.r) {
                    b.active = false;
                    this.bullet.active = false;
                    playPop();
                    this.resetBullet();
                    this.scoreLogic();
                    break;
                }
            }
        }
        if (this.bubbles.filter(b => b.active).length === 0) {
            state.level++;
            this.generateLevel();
        }
    },
    scoreLogic() {
        state.combo++;
        state.score += 10 * state.combo;
        state.balance += 0.0001; // SimulaÃ§Ã£o de ganho Web3
        updateUI();
    },
    draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
       
        // Desenha Bolhas
        this.bubbles.forEach(b => {
            if (!b.active) return;
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
            ctx.fillStyle = b.color;
            ctx.fill();
            ctx.strokeStyle = "rgba(255,255,255,0.2)";
            ctx.stroke();
        });
        // Desenha ProjÃ©til
        ctx.beginPath();
        ctx.arc(this.bullet.x, this.bullet.y, this.bullet.r, 0, Math.PI*2);
        ctx.fillStyle = this.bullet.color;
        ctx.fill();
        // Linha de mira (se carregando)
        if (this.isCharging) {
            ctx.beginPath();
            ctx.moveTo(this.bullet.x, this.bullet.y);
            ctx.lineTo(mouseX, mouseY);
            ctx.strokeStyle = "rgba(0,255,170,0.3)";
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
        }
    },
    loop() {
        Game.update();
        Game.draw();
        requestAnimationFrame(() => Game.loop());
    }
};
/* --- INPUTS --- */
let mouseX, mouseY;
canvas.addEventListener("mousemove", e => {
    const rect = canvas.getBoundingClientRect();
    mouseX = e.clientX - rect.left;
    mouseY = e.clientY - rect.top;
});
canvas.addEventListener("mousedown", () => { if(signed) Game.isCharging = true; });
canvas.addEventListener("mouseup", () => {
    if (!Game.isCharging) return;
    Game.isCharging = false;
    const angle = Math.atan2(mouseY - Game.bullet.y, mouseX - Game.bullet.x);
    const speed = 5 + Game.power;
    Game.bullet.dx = Math.cos(angle) * speed;
    Game.bullet.dy = Math.sin(angle) * speed;
    Game.bullet.active = true;
    Game.power = 0;
    ui.power.style.width = "0%";
});
/* --- TICKER REAL --- */
async function fetchPrices() {
    try {
        const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,arc-block&vs_currencies=usd");
        const data = await res.json();
        document.getElementById("tickerTrack").innerHTML =
            `BTC: $${data.bitcoin.usd} | ETH: $${data.ethereum.usd} | ARC: $0.1242 (Testnet) â€¢ `;
    } catch(e) { console.log("Ticker offline"); }
}
fetchPrices();
setInterval(fetchPrices, 60000); // 1 minuto para evitar ban de IP
</script>
</body>
</html>
