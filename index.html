
import React, { useState, useEffect, useCallback } from 'react';
import Sidebar from './components/Sidebar';
import GameCanvas from './components/GameCanvas';
import Ticker from './components/Ticker';
import { useWeb3 } from './hooks/useWeb3';
import { GameStatus, GameState } from './types';
import { getAIStrategyTip } from './services/geminiService';

const App: React.FC = () => {
  const { account, balance, isSigned, connect, sign } = useWeb3();
  const [status, setStatus] = useState<GameStatus>(GameStatus.LOCKED);
  const [gameState, setGameState] = useState<GameState>({
    score: 0,
    balance: 0,
    level: 1,
    combo: 0
  });
  const [aiTip, setAiTip] = useState("Connect your wallet to begin.");

  // Fetch AI tip when level changes
  useEffect(() => {
    const fetchTip = async () => {
      const tip = await getAIStrategyTip(gameState.level, gameState.score);
      setAiTip(tip);
    };
    if (isSigned) fetchTip();
  }, [gameState.level, isSigned]);

  const updateGameState = useCallback((update: Partial<GameState>) => {
    setGameState(prev => ({ ...prev, ...update }));
  }, []);

  const startGame = () => {
    setStatus(GameStatus.PLAYING);
    setGameState({ score: 0, balance: 0, level: 1, combo: 0 });
  };

  return (
    <div className="flex w-full h-screen overflow-hidden bg-background">
      {/* Background visual effects */}
      <div className="fixed inset-0 pointer-events-none opacity-20">
        <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-primary/20 blur-[100px] rounded-full" />
        <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-secondary/20 blur-[100px] rounded-full" />
      </div>

      <Sidebar 
        account={account}
        balance={balance}
        isSigned={isSigned}
        gameState={gameState}
        onConnect={connect}
        onSign={sign}
        onStart={startGame}
        status={status}
        aiTip={aiTip}
      />

      <main className="flex-1 relative p-6 pb-12 flex items-center justify-center">
        <div className="w-full max-w-4xl h-full flex flex-col">
          <GameCanvas 
            status={status}
            gameState={gameState}
            onUpdateState={updateGameState}
            onGameEnd={() => setStatus(GameStatus.GAMEOVER)}
          />
        </div>

        {/* Game Overlay Screens */}
        {status === GameStatus.LOCKED && !isSigned && (
          <div className="absolute inset-0 bg-black/80 backdrop-blur-md flex flex-col items-center justify-center z-10 p-10 text-center">
            <div className="w-20 h-20 mb-6 flex items-center justify-center bg-primary/20 rounded-full border border-primary animate-pulse">
               <span className="text-4xl">ðŸ”’</span>
            </div>
            <h2 className="text-4xl font-black mb-4">ACCESS RESTRICTED</h2>
            <p className="text-gray-400 max-w-md">
              Please authenticate using MetaMask on the ARC Testnet to access the tactical simulation.
            </p>
          </div>
        )}

        {status === GameStatus.GAMEOVER && (
          <div className="absolute inset-0 bg-black/90 backdrop-blur-md flex flex-col items-center justify-center z-10 p-10 text-center">
            <h2 className="text-5xl font-black text-red-500 mb-4">MISSION TERMINATED</h2>
            <div className="text-2xl font-mono mb-8 space-y-2">
              <p>Final Score: <span className="text-primary">{gameState.score}</span></p>
              <p>Yield Generated: <span className="text-secondary">{gameState.balance.toFixed(4)} USDC</span></p>
            </div>
            <button 
              onClick={startGame}
              className="px-10 py-4 bg-primary text-black font-bold rounded-xl hover:scale-105 transition-all"
            >
              REDEPLOY MISSION
            </button>
          </div>
        )}
      </main>

      <Ticker />
    </div>
  );
};

export default App;
