<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Bubble Shooter Web3 ARC</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<style>
body{margin:0;background:#050b1a;color:#fff;font-family:Arial;overflow:hidden;}
canvas{display:block;}
.panel{
  position:fixed;top:10px;left:10px;background:#0b1530;
  padding:12px;border-radius:12px;border:1px solid #00ffaa;
  font-size:13px;z-index:10;width:280px;
}
button{
  width:100%;margin:4px 0;padding:6px;border:none;border-radius:6px;
  background:#00ffaa;color:#000;font-weight:bold;cursor:pointer;
}
.bar{width:200px;height:10px;border:1px solid #0ff;margin-top:6px;}
#power{height:100%;width:0%;background:linear-gradient(90deg,#00ff88,#ff0,#f00);}
#menu{
  position:fixed;inset:0;background:rgba(0,0,0,.85);
  display:flex;align-items:center;justify-content:center;z-index:20;
}
.menu-box{
  background:#0b1530;padding:20px;border-radius:16px;border:2px solid #00ffaa;
  width:340px;text-align:center;
}
</style>
</head>
<body>

<div id="menu">
  <div class="menu-box">
    <h2>üéÆ Bubble Shooter Web3 ARC</h2>
    <button onclick="connectWallet()">ü¶ä Conectar MetaMask (ARC)</button>
    <button onclick="startGame()">‚ñ∂Ô∏è Jogar</button>
    <div id="walletStatus">Carteira: desconectada</div>
  </div>
</div>

<div class="panel">
  <div>üåê Rede: ARC Testnet</div>
  <div>üëõ Wallet: <span id="wallet">---</span></div>
  <div>üí∞ USDC: <span id="balance">0</span></div>
  <div>‚≠ê Score: <span id="score">0</span></div>
  <div>üî• Combo: <span id="combo">0</span></div>
  <div>üéØ Level: <span id="level">1</span></div>
  <div>‚ö° Power</div>
  <div class="bar"><div id="power"></div></div>
  <button onclick="depositUSDC()">üí∞ Depositar 0.01 USDC</button>
  <button onclick="withdrawUSDC()">üí∏ Sacar 0.10 USDC</button>
</div>

<canvas id="game"></canvas>

<script>
/* ===========================
   CONFIG ARC NETWORK + USDC
=========================== */
const ARC_NETWORK = {
  chainId: "0x4CE8E2", // 5042002 em hex
  chainName: "ARC Testnet",
  rpcUrls: ["https://rpc.testnet.arc.network"],
  nativeCurrency: { name: "ARC", symbol: "ARC", decimals: 18 },
  blockExplorerUrls: []
};

const USDC_ADDRESS = "0x3600000000000000000000000000000000000000";
const USDC_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function transfer(address,uint256) returns (bool)",
  "function approve(address,uint256) returns (bool)",
  "function decimals() view returns (uint8)"
];

/* ===========================
   CANVAS
=========================== */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
addEventListener("resize",resize);resize();

/* ===========================
   STATE
=========================== */
const State={
  balance:0,
  score:0,
  combo:0,
  level:1,
  wallet:null,
  lastPlay:0,
  provider:null,
  signer:null,
  usdc:null,
  decimals:6
};

function updateUI(){
  balance.textContent=State.balance.toFixed(4);
  score.textContent=State.score;
  combo.textContent=State.combo;
  level.textContent=State.level;
  wallet.textContent=State.wallet?State.wallet.slice(0,6)+"..."+State.wallet.slice(-4):"---";
}

/* ===========================
   METAMASK + ARC NETWORK
=========================== */
async function connectWallet(){
  if(!window.ethereum){alert("MetaMask n√£o encontrada");return;}

  try{
    await ethereum.request({
      method:"wallet_addEthereumChain",
      params:[ARC_NETWORK]
    });
  }catch(e){}

  await ethereum.request({method:"eth_requestAccounts"});
  State.provider = new ethers.providers.Web3Provider(window.ethereum);
  State.signer = State.provider.getSigner();
  State.wallet = await State.signer.getAddress();

  State.usdc = new ethers.Contract(USDC_ADDRESS, USDC_ABI, State.signer);
  State.decimals = await State.usdc.decimals();

  walletStatus.textContent="Carteira: "+State.wallet;
  await loadUSDCBalance();
}

async function loadUSDCBalance(){
  if(!State.usdc) return;
  const bal = await State.usdc.balanceOf(State.wallet);
  State.balance = parseFloat(ethers.utils.formatUnits(bal, State.decimals));
}

/* ===========================
   GAME ACCESS (3H LIMIT)
=========================== */
function startGame(){
  if(!State.wallet){alert("Conecte a MetaMask primeiro");return;}
  const now=Date.now();
  if(now-State.lastPlay<3*60*60*1000){
    alert("‚è≥ Aguarde 3 horas para jogar novamente.");
    return;
  }
  State.lastPlay=now;
  menu.style.display="none";
}

/* ===========================
   DEPOSIT / WITHDRAW (REAL USDC)
=========================== */
async function depositUSDC(){
  if(!State.usdc) return alert("Conecte a carteira.");
  const amount = ethers.utils.parseUnits("0.01", State.decimals);

  try{
    const tx = await State.usdc.transfer(
      "0x000000000000000000000000000000000000dEaD", // endere√ßo do jogo (exemplo)
      amount
    );
    await tx.wait();
    alert("‚úÖ Dep√≥sito enviado!");
    await loadUSDCBalance();
  }catch(e){
    alert("Erro no dep√≥sito.");
  }
}

function withdrawUSDC(){
  alert("‚ö†Ô∏è Saque real precisa de SMART CONTRACT do jogo.");
}

/* ===========================
   PARTICLES
=========================== */
const particles=[];
function explode(x,y,color){
  for(let i=0;i<30;i++){
    particles.push({
      x,y,
      vx:(Math.random()-0.5)*7,
      vy:(Math.random()-0.5)*7,
      life:40,
      color
    });
  }
}
function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.life--;
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x,p.y,3,3);
    if(p.life<=0)particles.splice(i,1);
  }
}

/* ===========================
   GAME ENGINE (UPGRADED)
=========================== */
const Game={
  bubbles:[],
  bullet:{x:0,y:0,r:18,dx:0,dy:0,active:false},
  charging:false,power:0,maxPower:25,

  resetBullet(){
    this.bullet.x=canvas.width/2;
    this.bullet.y=canvas.height-60;
    this.bullet.active=false;
  },

  init(){
    this.bubbles=[];
    const colors=["#00ff88","#2775ca","#ffca28","#ff4444"];
    const gapX=50,gapY=45;
    const cols=Math.floor(canvas.width/gapX);
    const rows=Math.floor(canvas.height*0.7/gapY);

    for(let i=0;i<rows;i++){
      for(let j=0;j<cols;j++){
        this.bubbles.push({
          x:gapX/2+j*gapX,
          y:gapY/2+i*gapY,
          r:18,
          color:colors[(i+j)%4],
          active:true
        });
      }
    }
    this.resetBullet();
  },

  shoot(angle){
    if(this.bullet.active)return;
    const speed=5+this.power;
    this.bullet.dx=Math.cos(angle)*speed;
    this.bullet.dy=Math.sin(angle)*speed;
    this.bullet.active=true;
    this.power=0;
  },

  update(){
    if(this.charging){
      this.power=Math.min(this.maxPower,this.power+0.35);
      power.style.width=(this.power/this.maxPower*100)+"%";
    }

    if(this.bullet.active){
      this.bullet.x+=this.bullet.dx;
      this.bullet.y+=this.bullet.dy;

      if(this.bullet.x<0||this.bullet.x>canvas.width)this.bullet.dx*=-1;
      if(this.bullet.y<0){this.resetBullet();State.combo=0;}

      for(const b of this.bubbles){
        if(!b.active)continue;
        const d=Math.hypot(this.bullet.x-b.x,this.bullet.y-b.y);
        if(d<this.bullet.r+b.r){
          b.active=false;
          explode(b.x,b.y,b.color);

          State.combo++;
          State.score+=10+State.combo*3;
          State.balance+=0.0005*(1+State.combo*0.15);

          this.resetBullet();
        }
      }
    }

    if(this.bubbles.filter(b=>b.active).length<8){
      State.level++;
      this.init();
    }
  },

  draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const b of this.bubbles){
      if(!b.active)continue;
      ctx.beginPath();
      ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
      ctx.fillStyle=b.color;
      ctx.shadowBlur=12;
      ctx.shadowColor=b.color;
      ctx.fill();
      ctx.shadowBlur=0;
    }
    ctx.beginPath();
    ctx.arc(this.bullet.x,this.bullet.y,this.bullet.r,0,Math.PI*2);
    ctx.fillStyle="#fff";ctx.fill();
    drawParticles();
  }
};

/* ===========================
   INPUT
=========================== */
canvas.addEventListener("mousedown",()=>Game.charging=true);
canvas.addEventListener("mouseup",(e)=>{
  Game.charging=false;
  const angle=Math.atan2(e.clientY-Game.bullet.y,e.clientX-Game.bullet.x);
  Game.shoot(angle);
});

/* ===========================
   LOOP
=========================== */
async function loop(){
  Game.update();
  Game.draw();
  updateUI();
  requestAnimationFrame(loop);
}
Game.init();
loop();
</script>
</body>
</html>